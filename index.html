<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educational Book Store - COD & Firebase</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles and font setting */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-padding {
            padding: 1rem; /* Default for mobile */
        }
        @media (min-width: 640px) {
            .container-padding {
                padding: 2rem;
            }
        }
        /* Custom scrollbar for better look */
        .overflow-y-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .overflow-y-scroll::-webkit-scrollbar-thumb {
            background-color: #a8a8a8;
            border-radius: 3px;
        }
        .tab-active {
            border-bottom: 2px solid #4F46E5;
            color: #4F46E5;
        }
        /* Mobile Cart Styles */
        #cart-container {
            transition: opacity 0.3s ease-in-out;
        }
        #cart-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Authentication Status Alert Banner -->
    <div id="auth-alert" class="hidden fixed top-0 left-0 right-0 z-50 p-3 text-center bg-red-600 text-white font-semibold rounded-b-lg shadow-xl">
        Authentication Error: Please check your Firebase Console setup and config values.
    </div>

    <!-- Main Header -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto container-padding flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600">EduBook Store (COD)</h1>
            <div class="flex items-center space-x-4">
                <div class="text-sm hidden sm:block text-gray-600 truncate">
                    User ID: <span id="user-id-display" class="font-mono text-xs font-semibold text-gray-800">Signing In...</span>
                </div>
                <button id="cart-button" class="relative p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Layout (Desktop) -->
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row container-padding gap-6">

        <!-- Left Column: Catalog, Inquiry Form, History -->
        <main class="lg:w-2/3 flex-grow space-y-8">
            
            <!-- Book Catalog -->
            <section id="catalog-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Educational Book Catalog</h2>
                <div id="catalog-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- Catalog items will be injected here -->
                </div>
            </section>

            <!-- Book Inquiry / Request Form -->
            <section id="inquiry-section" class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 text-indigo-700">Book Inquiry / Request Form</h2>
                <p class="text-sm text-gray-500 mb-4">Can't find a book? Submit a request here. We will contact you soon!</p>
                
                <form id="inquiry-form" class="space-y-4">
                    <div>
                        <label for="inquiry-book-name" class="block text-sm font-medium text-gray-700">Book Name / Topic *</label>
                        <input type="text" id="inquiry-book-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                    </div>
                    <div>
                        <label for="inquiry-phone" class="block text-sm font-medium text-gray-700">Mobile Number *</label>
                        <input type="tel" id="inquiry-phone" required pattern="[0-9]{10}" title="10-digit mobile number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                    </div>
                    <div>
                        <label for="inquiry-address" class="block text-sm font-medium text-gray-700">Address for Contact *</label>
                        <textarea id="inquiry-address" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border"></textarea>
                    </div>
                    <button type="submit" id="submit-inquiry-btn" class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        Submit Inquiry
                    </button>
                </form>
            </section>

            <!-- Order/Inquiry History -->
            <section id="history-section" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Your History</h2>
                <div class="flex border-b mb-4">
                    <button id="tab-orders" class="px-4 py-2 text-sm font-medium transition duration-150 ease-in-out tab-active">Your Orders</button>
                    <button id="tab-inquiries" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700 transition duration-150 ease-in-out">Your Inquiries</button>
                </div>
                
                <div id="orders-list" class="space-y-4">
                    <!-- History list for Orders -->
                    <p class="text-gray-500 italic">No previous orders found.</p>
                </div>
                
                <div id="inquiries-list" class="space-y-4 hidden">
                    <!-- History list for Inquiries -->
                    <p class="text-gray-500 italic">No previous inquiries found.</p>
                </div>
            </section>

        </main>

        <!-- Right Column: Cart and Checkout (Fixed Position on Desktop) -->
        <aside id="cart-container" class="lg:w-1/3 fixed lg:sticky top-0 right-0 h-full lg:h-auto z-40 bg-gray-900 bg-opacity-50 lg:bg-transparent transition-opacity opacity-0 pointer-events-none lg:opacity-100 lg:pointer-events-auto">
            <div id="cart-content" class="h-full w-full lg:w-auto transform translate-x-full lg:translate-x-0 bg-white p-6 rounded-l-xl lg:rounded-xl shadow-2xl lg:shadow-lg overflow-y-scroll space-y-6 lg:mt-[96px]">
                
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Your Cart</h3>
                    <button id="close-cart-button" class="lg:hidden p-2 rounded-full text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <!-- Cart Items List -->
                <div id="cart-items" class="space-y-4">
                    <p id="empty-cart-message" class="text-center text-gray-500 italic">Your cart is empty.</p>
                    <!-- Cart items will be injected here -->
                </div>

                <!-- Summary -->
                <div class="pt-4 border-t space-y-2">
                    <div class="flex justify-between text-base font-medium text-gray-900">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">₹0</span>
                    </div>
                    <div class="flex justify-between text-sm text-green-600">
                        <span>Delivery Charge</span>
                        <span>FREE</span>
                    </div>
                    <div class="flex justify-between text-xl font-bold text-indigo-700 pt-2 border-t">
                        <span>Total Amount</span>
                        <span id="cart-total">₹0</span>
                    </div>
                </div>

                <!-- Checkout Form -->
                <form id="checkout-form" class="space-y-4 pt-4">
                    <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Delivery Details</h4>
                    
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-gray-700">Full Name *</label>
                        <input type="text" id="customer-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-gray-700">Mobile Number *</label>
                        <input type="tel" id="customer-phone" required pattern="[0-9]{10}" title="10-digit mobile number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                    <div>
                        <label for="customer-address" class="block text-sm font-medium text-gray-700">Full Delivery Address *</label>
                        <textarea id="customer-address" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <div class="bg-indigo-50 p-3 rounded-lg flex items-center justify-between">
                        <span class="text-sm font-medium text-indigo-800">Payment Method:</span>
                        <span class="font-semibold text-indigo-900">Cash on Delivery (COD)</span>
                    </div>
                    
                    <button type="submit" id="place-order-btn" class="w-full inline-flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out" disabled>
                        Place Order (COD)
                    </button>
                </form>

            </div>
        </aside>

    </div>

    <!-- Confirmation Modal (Hidden by default) -->
    <div id="order-modal" class="fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 transition-opacity opacity-0 pointer-events-none flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-transform scale-95">
            
            <div class="text-center">
                <svg id="modal-icon" xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <h3 id="modal-title" class="mt-2 text-xl leading-6 font-medium text-gray-900">Order Placed Successfully!</h3>
                <div class="mt-4 text-sm text-gray-500 text-left overflow-x-auto">
                    <p class="font-semibold mb-2" id="modal-description">Your order details have been confirmed and will be processed soon.</p>
                    <pre id="modal-details" class="bg-gray-100 p-3 rounded-lg overflow-x-auto text-xs text-gray-700"></pre>
                </div>
            </div>

            <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                <button type="button" id="copy-details-button" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm transition">
                    Copy Details
                </button>
                <button type="button" id="close-modal-button" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm transition">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript Section -->
    <script type="module">
        // --- FIREBASE CONFIGURATION (MANDATORY) ---
        // REPLACE THE PLACEHOLDERS BELOW with your actual Firebase project credentials.
        const staticFirebaseConfig = {
            apiKey: "AIzaSyC8OWYs1q-OL2NclpofPnJ2m21qU5cfCUc", 
            authDomain: "edubooks-90e7e.firebaseapp.com",
            projectId: "edubooks-90e7e",
            storageBucket: "edubooks-90e7e.firebasestorage.app",
            messagingSenderId: "365550668919",
            appId: "1:365550668919:web:d8d7d978ad65132883ca72"

        };
        
        // Use the static config for local hosting
        const firebaseConfig = staticFirebaseConfig;
        const appId = firebaseConfig.projectId || 'default-app-id'; // Use project ID as app ID for simplicity
        const apiKey = firebaseConfig.apiKey;

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES ---
        let db;
        let auth;
        let currentUserId = null;
        let cart = JSON.parse(localStorage.getItem('bookCart')) || [];
        
        // --- DOM REFERENCES ---
        const userIdDisplay = document.getElementById('user-id-display');
        const authAlert = document.getElementById('auth-alert');
        const catalogGrid = document.getElementById('catalog-grid');
        const cartItemsContainer = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSubtotal = document.getElementById('cart-subtotal');
        const cartTotal = document.getElementById('cart-total');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const checkoutForm = document.getElementById('checkout-form');
        const inquiryForm = document.getElementById('inquiry-form');
        const submitInquiryBtn = document.getElementById('submit-inquiry-btn');
        const orderModal = document.getElementById('order-modal');
        const modalDetails = document.getElementById('modal-details');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalIcon = document.getElementById('modal-icon');
        const cartCount = document.getElementById('cart-count');
        
        const historyTabs = {
            orders: document.getElementById('tab-orders'),
            inquiries: document.getElementById('tab-inquiries')
        };
        const historyLists = {
            orders: document.getElementById('orders-list'),
            inquiries: document.getElementById('inquiries-list')
        };

        // --- MOCK DATA ---
        const BOOKS = [
            { id: 'math101', name: 'Advanced Calculus', price: 650, author: 'Dr. A. Sharma', year: 2023, image: `https://placehold.co/100x150/4F46E5/ffffff?text=Math` },
            { id: 'phy202', name: 'Quantum Mechanics', price: 920, author: 'Prof. J. Singh', year: 2022, image: `https://placehold.co/100x150/10B981/ffffff?text=Physics` },
            { id: 'hist303', name: 'Ancient Civilizations', price: 480, author: 'S. K. Gupta', year: 2021, image: `https://placehold.co/100x150/F59E0B/ffffff?text=History` },
            { id: 'cs404', name: 'Data Structures in C++', price: 790, author: 'P. V. Kumar', year: 2023, image: `https://placehold.co/100x150/EF4444/ffffff?text=CS` }
        ];

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        try {
            // CRITICAL CHECK: Ensure placeholders are replaced when running locally
            if (firebaseConfig.apiKey.includes("YOUR_API_KEY_HERE") || firebaseConfig.projectId.includes("YOUR_PROJECT_ID_HERE")) {
                const placeholderError = "CRITICAL ERROR: Firebase configuration placeholders are still present. You MUST replace 'YOUR_API_KEY_HERE' and other values with your actual Firebase project credentials for the app to work locally.";
                console.error(placeholderError);
                authAlert.textContent = placeholderError;
                authAlert.classList.remove('hidden');
                throw new Error("Missing Firebase Credentials"); // Stop execution
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Set persistence to local so anonymous user stays logged in
            setPersistence(auth, browserLocalPersistence);

            // Check if a custom token is available (from Canvas environment)
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = currentUserId;
                    authAlert.classList.add('hidden');
                    console.log('Firebase Authentication Success. User ID:', currentUserId);
                    
                    // Start real-time listeners once authenticated
                    startHistoryListeners();
                } else if (initialAuthToken) {
                    // Sign in with custom token if available (Canvas environment)
                    await signInWithCustomToken(auth, initialAuthToken).catch(error => {
                        console.error("Custom Token Sign-in Failed:", error);
                        // Fallback to anonymous sign-in on custom token failure
                        attemptAnonymousSignIn();
                    });
                } else {
                    // Attempt anonymous sign-in for local or external hosting
                    attemptAnonymousSignIn();
                }
            });
            
        } catch (error) {
            if (error.message !== "Missing Firebase Credentials") {
                console.error("Firebase Initialization Failed:", error);
                authAlert.classList.remove('hidden');
                authAlert.textContent = `FATAL ERROR: Initialization failed. Check console and config.`;
            }
        }

        async function attemptAnonymousSignIn() {
             userIdDisplay.textContent = 'Signing In...';
             try {
                await signInAnonymously(auth);
                // onAuthStateChanged handler will pick up the successful sign-in
             } catch(error) {
                console.error("Anonymous Sign-in Failed:", error);
                userIdDisplay.textContent = 'Auth Failed';
                authAlert.classList.remove('hidden');
                authAlert.textContent = `FATAL ERROR: Authentication failed (${error.code}). Check your Firebase Config and ensure Anonymous Auth is enabled.`;
             }
        }


        // --- RENDERING FUNCTIONS ---

        function renderCatalog() {
            catalogGrid.innerHTML = BOOKS.map(book => `
                <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden border border-gray-100 p-4 flex flex-col justify-between">
                    <div class="flex items-center space-x-4 mb-4">
                        <img src="${book.image}" alt="${book.name}" class="w-16 h-24 object-cover rounded-md shadow-inner">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800">${book.name}</h3>
                            <p class="text-sm text-gray-500">${book.author} (${book.year})</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-end">
                        <span class="text-xl font-bold text-indigo-600">₹${book.price.toFixed(2)}</span>
                        <button onclick="addToCart('${book.id}')" class="flex items-center space-x-1 py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out text-sm font-medium shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            <span>Add</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        window.addToCart = function(bookId) {
            const book = BOOKS.find(b => b.id === bookId);
            if (book) {
                const existingItem = cart.find(item => item.id === bookId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({ ...book, quantity: 1 });
                }
                updateCartDisplay();
                
                // Show a confirmation bubble (optional: using the modal as a temporary message box)
                showTemporaryMessage(`${book.name} added to cart!`);
            }
        };

        window.removeFromCart = function(bookId) {
            const index = cart.findIndex(item => item.id === bookId);
            if (index > -1) {
                cart.splice(index, 1);
                updateCartDisplay();
            }
        };

        function updateCartDisplay() {
            localStorage.setItem('bookCart', JSON.stringify(cart));
            cartItemsContainer.innerHTML = '';
            
            const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const total = subtotal; // Delivery is free

            cartSubtotal.textContent = `₹${subtotal.toFixed(2)}`;
            cartTotal.textContent = `₹${total.toFixed(2)}`;
            cartCount.textContent = cart.length;

            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                placeOrderBtn.disabled = true;
                return;
            }
            
            emptyCartMessage.classList.add('hidden');
            placeOrderBtn.disabled = false; // Enabled by cart size, further checked by form validation

            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'flex justify-between items-center py-2 border-b last:border-b-0';
                itemElement.innerHTML = `
                    <div class="flex-1 pr-4">
                        <p class="font-medium text-gray-800">${item.name}</p>
                        <p class="text-sm text-gray-500">₹${item.price} x ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="font-semibold text-indigo-600">₹${(item.price * item.quantity).toFixed(2)}</span>
                        <button onclick="removeFromCart('${item.id}')" class="p-1 text-red-500 hover:text-red-700 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemElement);
            });
        }
        
        // Function to display a confirmation message modal
        function showConfirmationModal(title, description, details) {
            modalTitle.textContent = title;
            modalDescription.textContent = description;
            modalDetails.textContent = details;
            
            // Set icon based on success
            modalIcon.classList.remove('text-red-500');
            modalIcon.classList.add('text-green-500');
            modalIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;

            orderModal.classList.remove('opacity-0', 'pointer-events-none');
            orderModal.querySelector('div').classList.remove('scale-95');
        }

        function showTemporaryMessage(message) {
            // A quick, minimal use of the modal for simple feedback
            modalTitle.textContent = 'Success!';
            modalDescription.textContent = message;
            modalDetails.textContent = '';
            modalIcon.classList.add('text-green-500');
            modalIcon.classList.remove('text-red-500');
            modalIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;

            document.getElementById('copy-details-button').classList.add('hidden');
            document.getElementById('close-modal-button').classList.remove('sm:col-start-1', 'sm:col-span-2');
            document.getElementById('close-modal-button').classList.add('sm:col-span-2');

            orderModal.classList.remove('opacity-0', 'pointer-events-none');
            orderModal.querySelector('div').classList.remove('scale-95');

            setTimeout(() => {
                orderModal.classList.add('opacity-0', 'pointer-events-none');
                orderModal.querySelector('div').classList.add('scale-95');
                // Reset buttons for future use
                document.getElementById('copy-details-button').classList.remove('hidden');
                document.getElementById('close-modal-button').classList.add('sm:col-start-1');
                document.getElementById('close-modal-button').classList.remove('sm:col-span-2');
            }, 1500);
        }


        // --- HISTORY RENDERING ---

        function renderHistory(listElement, data, type) {
            listElement.innerHTML = '';
            if (data.length === 0) {
                listElement.innerHTML = `<p class="text-gray-500 italic">No previous ${type.toLowerCase()} found.</p>`;
                return;
            }

            data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            data.forEach(item => {
                let details;
                let title;
                let statusColor = item.status === 'Pending' || item.status === 'New' ? 'text-yellow-600 bg-yellow-100' : 'text-green-600 bg-green-100';

                if (type === 'Orders') {
                    title = `Order #${item.id.substring(0, 8)}`;
                    details = `Total: ₹${item.totalAmount.toFixed(2)} | Items: ${item.items.length}`;
                } else { // Inquiries
                    title = `Inquiry for: ${item.bookName}`;
                    details = `Contact: ${item.phone} | Address: ${item.address.substring(0, 30)}...`;
                }

                listElement.innerHTML += `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-semibold text-gray-800">${title}</p>
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusColor}">
                                ${item.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600">${details}</p>
                        <p class="text-xs text-gray-400 mt-1">Submitted: ${new Date(item.timestamp).toLocaleString()}</p>
                    </div>
                `;
            });
        }


        // --- FIREBASE LISTENERS ---

        function startHistoryListeners() {
            if (!db || !currentUserId) return;

            // Ensure to use the correct public path for collaborative apps
            const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
            const ordersQuery = query(ordersCollectionRef, where("userId", "==", currentUserId));
            
            // Listen for user's orders
            onSnapshot(ordersQuery, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory(historyLists.orders, orders, 'Orders');
            }, (error) => {
                console.error("Error listening to orders:", error);
            });

            // Ensure to use the correct public path for collaborative apps
            const inquiriesCollectionRef = collection(db, `artifacts/${appId}/public/data/inquiries`);
            const inquiriesQuery = query(inquiriesCollectionRef, where("userId", "==", currentUserId));
            
            // Listen for user's inquiries
            onSnapshot(inquiriesQuery, (snapshot) => {
                const inquiries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory(historyLists.inquiries, inquiries, 'Inquiries');
            }, (error) => {
                console.error("Error listening to inquiries:", error);
            });
        }


        // --- FORM SUBMISSION HANDLERS ---

        async function saveOrder(orderData) {
            if (!currentUserId) {
                console.error("Cannot save order: User not authenticated.");
                showConfirmationModal("Submission Failed", "Authentication Error: Please check your Firebase setup. Cannot submit order without a valid User ID.", JSON.stringify(orderData, null, 2));
                return;
            }

            placeOrderBtn.textContent = 'Saving Order...';
            placeOrderBtn.disabled = true;

            const finalOrderData = {
                ...orderData,
                userId: currentUserId,
                timestamp: new Date().toISOString(), // Use ISO string for reliable sorting/storage
                status: 'Pending',
                paymentMethod: 'Cash on Delivery (COD)'
            };

            try {
                // Use the correct public path
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), finalOrderData);
                console.log("Order submitted successfully. Doc ID:", docRef.id);

                showConfirmationModal(
                    "Order Placed Successfully!", 
                    `Your order (ID: ${docRef.id.substring(0, 8)}) has been confirmed. You chose COD.`, 
                    JSON.stringify(finalOrderData, null, 2)
                );
                
                // Clear cart and reset form
                cart = [];
                updateCartDisplay();
                checkoutForm.reset();

            } catch (e) {
                console.error("Error adding document to Firestore:", e);
                // The most common error here is a Security Rule violation (Permission Denied)
                showConfirmationModal(
                    "Submission Failed (Firestore Error)", 
                    `Could not save the document. This is often due to an invalid Firebase Security Rule (Error: ${e.code || e.message}).`, 
                    JSON.stringify(finalOrderData, null, 2)
                );
            } finally {
                placeOrderBtn.textContent = 'Place Order (COD)';
                placeOrderBtn.disabled = false;
            }
        }
        
        async function saveInquiry(inquiryData) {
            if (!currentUserId) {
                console.error("Cannot save inquiry: User not authenticated.");
                showConfirmationModal("Submission Failed", "Authentication Error: Please check your Firebase setup. Cannot submit inquiry without a valid User ID.", JSON.stringify(inquiryData, null, 2));
                return;
            }

            submitInquiryBtn.textContent = 'Saving Inquiry...';
            submitInquiryBtn.disabled = true;

            const finalInquiryData = {
                ...inquiryData,
                userId: currentUserId,
                timestamp: new Date().toISOString(),
                status: 'New'
            };

            try {
                // Use the correct public path
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/inquiries`), finalInquiryData);
                console.log("Inquiry submitted successfully. Doc ID:", docRef.id);

                showConfirmationModal(
                    "Inquiry Submitted Successfully!", 
                    `Your inquiry (ID: ${docRef.id.substring(0, 8)}) has been recorded. We will contact you at ${inquiryData.phone}.`, 
                    JSON.stringify(finalInquiryData, null, 2)
                );
                inquiryForm.reset();

            } catch (e) {
                console.error("Error adding inquiry to Firestore:", e);
                // The most common error here is a Security Rule violation (Permission Denied)
                showConfirmationModal(
                    "Submission Failed (Firestore Error)", 
                    `Could not save the inquiry. This is often due to an invalid Firebase Security Rule (Error: ${e.code || e.message}).`, 
                    JSON.stringify(finalInquiryData, null, 2)
                );
            } finally {
                submitInquiryBtn.textContent = 'Submit Inquiry';
                submitInquiryBtn.disabled = false;
            }
        }

        checkoutForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Ensure cart is not empty and form is valid
            if (cart.length === 0 || !checkoutForm.checkValidity()) {
                // Using custom UI instead of alert() would be better, but simplified here.
                showConfirmationModal("Missing Information", "Please add items to your cart and fill out all required delivery fields.", "");
                return;
            }

            const totalAmount = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

            const orderData = {
                name: document.getElementById('customer-name').value,
                phone: document.getElementById('customer-phone').value,
                address: document.getElementById('customer-address').value,
                items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity })),
                totalAmount: totalAmount,
            };

            saveOrder(orderData);
        });

        inquiryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Ensure form is valid
            if (!inquiryForm.checkValidity()) {
                return;
            }

            const inquiryData = {
                bookName: document.getElementById('inquiry-book-name').value,
                phone: document.getElementById('inquiry-phone').value,
                address: document.getElementById('inquiry-address').value
            };

            saveInquiry(inquiryData);
        });
        
        // --- UTILITY HANDLERS ---
        
        // Tab switching logic for history
        historyTabs.orders.addEventListener('click', () => {
            historyTabs.orders.classList.add('tab-active');
            historyTabs.inquiries.classList.remove('tab-active', 'text-gray-500');
            historyLists.orders.classList.remove('hidden');
            historyLists.inquiries.classList.add('hidden');
        });

        historyTabs.inquiries.addEventListener('click', () => {
            historyTabs.inquiries.classList.add('tab-active');
            historyTabs.orders.classList.remove('tab-active', 'text-gray-500');
            historyLists.inquiries.classList.remove('hidden');
            historyLists.orders.classList.add('hidden');
        });

        document.getElementById('copy-details-button').addEventListener('click', () => {
            try {
                navigator.clipboard.writeText(modalDetails.textContent);
                document.getElementById('copy-details-button').textContent = 'Copied!';
                setTimeout(() => {
                    document.getElementById('copy-details-button').textContent = 'Copy Details';
                }, 2000);
            } catch (err) {
                 // Fallback for environments where clipboard API is restricted
                 const textArea = document.createElement("textarea");
                 textArea.value = modalDetails.textContent;
                 document.body.appendChild(textArea);
                 textArea.focus();
                 textArea.select();
                 try {
                    document.execCommand('copy');
                    document.getElementById('copy-details-button').textContent = 'Copied!';
                    setTimeout(() => {
                        document.getElementById('copy-details-button').textContent = 'Copy Details';
                    }, 2000);
                 } catch (err) {
                    // Using custom UI instead of alert() would be better, but simplified here.
                    showConfirmationModal("Copy Failed", "Your browser does not support automatic copying. Please manually select and copy the details from the box above.", "");
                 }
                 document.body.removeChild(textArea);
            }
        });

        // --- MOBILE CART HANDLERS ---
        
        const cartContainer = document.getElementById('cart-container');
        const cartButton = document.getElementById('cart-button');
        const closeCartButton = document.getElementById('close-cart-button');
        const closeModalButton = document.getElementById('close-modal-button');
        
        const hideMobileCart = () => {
             cartContainer.classList.add('opacity-0', 'pointer-events-none');
             cartContainer.querySelector('div').classList.remove('translate-x-0');
             cartContainer.querySelector('div').classList.add('translate-x-full');
        };

        const showMobileCart = () => {
             cartContainer.classList.remove('opacity-0', 'pointer-events-none');
             cartContainer.querySelector('div').classList.remove('translate-x-full');
             cartContainer.querySelector('div').classList.add('translate-x-0');
        };

        // Event Listeners for mobile cart and modal
        cartButton.addEventListener('click', showMobileCart);
        closeCartButton.addEventListener('click', hideMobileCart);
        cartContainer.addEventListener('click', (e) => {
            if (e.target === cartContainer && window.innerWidth < 1024) {
                hideMobileCart();
            }
        });
        
        closeModalButton.addEventListener('click', () => {
            orderModal.classList.add('opacity-0', 'pointer-events-none');
            orderModal.querySelector('div').classList.add('scale-95');
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            renderCatalog();
            updateCartDisplay();
            // startHistoryListeners is now called inside onAuthStateChanged
        };

    </script>
</body>
</html>
