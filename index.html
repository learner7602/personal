<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice-to-Text Document Creator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for custom colors and Inter font -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for the microphone button animation */
        .mic-button-active {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div class="w-full max-w-3xl bg-white p-6 md:p-10 rounded-xl shadow-2xl border border-gray-200">
        <h1 class="text-3xl font-extrabold text-primary text-center mb-2">Voice Document Writer</h1>
        <p class="text-gray-500 text-center mb-6">Start speaking to draft your text in real-time.</p>

        <!-- Language Selector -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="lang-en" data-lang="en-US" 
                    class="lang-button px-4 py-2 text-sm font-semibold rounded-full transition duration-150">
                English
            </button>
            <button id="lang-bn" data-lang="bn-BD" 
                    class="lang-button px-4 py-2 text-sm font-semibold rounded-full transition duration-150">
                বাংলা (Bengali)
            </button>
        </div>

        <!-- Status Message -->
        <div id="status" class="text-center mb-6 text-sm font-medium h-6 text-gray-700">
            Click the microphone to begin.
        </div>

        <!-- Text Output Area -->
        <textarea id="output-text" rows="10" placeholder="Your transcribed text will appear here..."
                  class="w-full p-4 border-2 border-primary rounded-lg shadow-inner focus:ring-secondary focus:border-secondary transition duration-150 ease-in-out resize-none text-gray-800"></textarea>

        <!-- Controls -->
        <div class="flex flex-col items-center justify-center gap-4 mt-6">
            
            <!-- Microphone Button -->
            <button id="mic-button"
                    class="w-20 h-20 flex items-center justify-center rounded-full bg-primary text-white shadow-lg transition duration-300 ease-in-out hover:bg-secondary focus:outline-none focus:ring-4 focus:ring-primary/50">
                <!-- SVG Microphone Icon -->
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 transition duration-150" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M6.25 10.155a.75.75 0 01.75.75v1.25a4 4 0 008 0v-1.25a.75.75 0 011.5 0v1.25a5.5 5.5 0 01-11 0v-1.25a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                    <path d="M11 14.75a.75.75 0 01.75.75v1.25H7.5v-1.25a.75.75 0 01.75-.75h3.5z" />
                </svg>
            </button>
            <span id="mic-text" class="text-lg font-semibold text-primary">Start Recording</span>

            <div class="w-full flex justify-center mt-4">
                <!-- Download Button -->
                <button id="download-button" disabled
                        class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 disabled:opacity-50 transition duration-150 ease-in-out">
                    Download Document (.txt)
                </button>
            </div>
        </div>

        <!-- Compatibility Warning -->
        <div id="compatibility-warning" class="mt-8 text-center p-3 bg-yellow-100 border border-yellow-300 rounded-lg hidden">
            <p class="text-sm text-yellow-800 font-medium">
                ⚠️ Browser Warning: Speech recognition is not supported or requires a secure context (HTTPS/localhost).
            </p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const micButton = document.getElementById('mic-button');
            const micText = document.getElementById('mic-text');
            const outputText = document.getElementById('output-text');
            const statusDiv = document.getElementById('status');
            const downloadButton = document.getElementById('download-button');
            const warningDiv = document.getElementById('compatibility-warning');
            const langEnButton = document.getElementById('lang-en');
            const langBnButton = document.getElementById('lang-bn');
            const languageButtons = document.querySelectorAll('.lang-button');

            const ACTIVE_LANG_CLASSES = ['text-white', 'bg-primary', 'shadow-md'];
            const INACTIVE_LANG_CLASSES = ['text-gray-600', 'bg-gray-200', 'hover:bg-primary/20', 'hover:text-primary'];

            let recognition = null;
            let isRecognizing = false;
            let finalTranscript = '';

            // Check for Speech Recognition API compatibility
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                warningDiv.classList.remove('hidden');
                micButton.disabled = true;
                micText.textContent = 'Not Supported';
                return;
            }

            // Initialize Speech Recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening even if pauses occur
            recognition.interimResults = true; // Show results as they are being recognized
            // recognition.lang will be set by the updateActiveLanguage function

            // --- Language Logic ---

            /**
             * Updates the active language setting for the recognition engine and updates the button styling.
             * @param {string} newLang - The language code (e.g., 'en-US', 'bn-BD').
             */
            function updateActiveLanguage(newLang) {
                if (isRecognizing) {
                    // Prevent changing language mid-recording
                    statusDiv.textContent = 'Please stop recording before changing the language.';
                    return;
                }
                
                languageButtons.forEach(btn => {
                    btn.classList.remove(...ACTIVE_LANG_CLASSES);
                    btn.classList.add(...INACTIVE_LANG_CLASSES);
                });

                const selectedButton = document.querySelector(`[data-lang="${newLang}"]`);
                if (selectedButton) {
                    selectedButton.classList.remove(...INACTIVE_LANG_CLASSES);
                    selectedButton.classList.add(...ACTIVE_LANG_CLASSES);
                    
                    recognition.lang = newLang;
                    statusDiv.textContent = `Language set to ${selectedButton.textContent}. Click the microphone to begin.`;
                }
            }

            // Set initial language to English on load
            updateActiveLanguage('en-US');

            // Add click listeners to the language buttons
            langEnButton.addEventListener('click', () => updateActiveLanguage(langEnButton.dataset.lang));
            langBnButton.addEventListener('click', () => updateActiveLanguage(langBnButton.dataset.lang));


            // --- Recognition Event Handlers ---

            recognition.onstart = () => {
                isRecognizing = true;
                micButton.classList.add('mic-button-active', 'bg-red-500');
                micButton.classList.remove('bg-primary', 'hover:bg-secondary');
                micText.textContent = 'Listening... Speak now.';
                statusDiv.textContent = `Listening in ${recognition.lang}. Speak clearly into your microphone.`;
            };

            recognition.onend = () => {
                isRecognizing = false;
                micButton.classList.remove('mic-button-active', 'bg-red-500');
                micButton.classList.add('bg-primary', 'hover:bg-secondary');
                micText.textContent = 'Start Recording';
                statusDiv.textContent = 'Recognition stopped.';
                
                // Ensure the final text is clean when saving/stopping
                finalTranscript = outputText.value.trim() + ' ';
                
                // Enable download button if there is text
                downloadButton.disabled = finalTranscript.trim() === '';
            };

            recognition.onerror = (event) => {
                isRecognizing = false;
                console.error('Speech Recognition Error:', event.error);
                statusDiv.textContent = `Error: ${event.error}. Click to retry.`;
                micButton.classList.remove('mic-button-active', 'bg-red-500');
                micButton.classList.add('bg-primary', 'hover:bg-secondary');
                micText.textContent = 'Start Recording';
            };

            recognition.onresult = (event) => {
                let currentInterim = '';
                
                // Loop through results from the current event's index up
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    
                    if (event.results[i].isFinal) {
                        // If it's final, add it to the permanent storage (with a space separator)
                        // This replaces the old logic that added '.\n'
                        finalTranscript += transcript + ' '; 
                    } else {
                        // If it's interim, store it temporarily (this usually catches the latest result)
                        currentInterim = transcript;
                    }
                }

                // Update the text area with final text plus the current interim result.
                let displayText = finalTranscript.trim();
                
                if (currentInterim.length > 0) {
                    // Add space only if permanent text exists and interim text is coming
                    if (displayText.length > 0) {
                         displayText += ' ';
                    }
                    displayText += currentInterim;
                }
                
                outputText.value = displayText;
            };

            // --- Button Handlers ---

            micButton.addEventListener('click', () => {
                if (isRecognizing) {
                    recognition.stop();
                } else {
                    // Start with the existing text content, ensuring it ends with a space for new dictation
                    finalTranscript = outputText.value.trim() + ' '; 
                    recognition.start();
                }
            });

            downloadButton.addEventListener('click', () => {
                const textToSave = outputText.value;

                if (!textToSave.trim()) {
                    statusDiv.textContent = 'Nothing to download. Please record some text first.';
                    return;
                }

                // Create a Blob containing the text data
                const blob = new Blob([textToSave], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);

                // Create a temporary link element to trigger the download
                const a = document.createElement('a');
                a.href = url;
                a.download = `voice_document_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                statusDiv.textContent = 'File downloaded successfully as .txt';
            });
            
            // Check if text is present to enable download button on load/changes
            outputText.addEventListener('input', () => {
                downloadButton.disabled = outputText.value.trim() === '';
            });

        });
    </script>
</body>
</html>
